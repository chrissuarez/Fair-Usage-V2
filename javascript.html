<script>
    // NAVIGATION
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');

        // Show selected
        document.getElementById(sectionId + '-section').style.display = 'block';

        // Update nav active state
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Simple logic to find the nav item (could be improved with IDs)
        const navItems = document.querySelectorAll('.nav-item');
        if (sectionId === 'fair-usage') navItems[0].classList.add('active');
        if (sectionId === 'tech-fee') navItems[1].classList.add('active');
        if (sectionId === 'cashflow') {
            navItems[2].classList.add('active');
            loadCashflowData(); // Load data when tab is opened
        }
        if (sectionId === 'entitlements') {
            navItems[3].classList.add('active');
            loadEntitlements();
        }
        if (sectionId === 'settings') navItems[4].classList.add('active');
    }

    // ACTIONS
    function runFairUsage() {
        const year = document.getElementById('fu-year').value;
        const statusEl = document.getElementById('fu-status');

        statusEl.textContent = 'Building allocation table...';
        statusEl.className = 'status-message status-loading';

        google.script.run
            .withSuccessHandler(function (res) {
                statusEl.textContent = 'Success! ' + res;
                statusEl.className = 'status-message status-success';
            })
            .withFailureHandler(function (err) {
                statusEl.textContent = 'Error: ' + err.message;
                statusEl.className = 'status-message status-error';
            })
            .Build_FairUsage_ForYear_Web(parseInt(year));
    }

    function runTechFee() {
        const year = document.getElementById('tf-year').value;
        const statusEl = document.getElementById('tf-status');

        statusEl.textContent = 'Running comparison...';
        statusEl.className = 'status-message status-loading';

        google.script.run
            .withSuccessHandler(function (res) {
                statusEl.textContent = 'Success! ' + res;
                statusEl.className = 'status-message status-success';
            })
            .withFailureHandler(function (err) {
                statusEl.textContent = 'Error: ' + err.message;
                statusEl.className = 'status-message status-error';
            })
            .Build_Tech_Fee_Join_Web(parseInt(year));
    }

    function runUpdateSetup() {
        const statusDiv = document.getElementById('setup-status');
        statusDiv.textContent = "Updating Setup tab...";
        statusDiv.className = "status-msg";

        google.script.run
            .withSuccessHandler(function (msg) {
                statusDiv.textContent = "Success! " + msg;
                statusDiv.className = "status-msg success";
            })
            .withFailureHandler(function (err) {
                statusDiv.textContent = "Error: " + err.message;
                statusDiv.className = "status-msg error";
            })
            .EnsureSetupTab_Web();
    }

    function runEnsureToolConfig() {
        const statusDiv = document.getElementById('tool-config-status');
        statusDiv.textContent = "Ensuring tab...";
        statusDiv.className = "status-msg";
        google.script.run
            .withSuccessHandler(function (msg) {
                statusDiv.textContent = msg;
                statusDiv.className = "status-msg success";
            })
            .withFailureHandler(function (err) {
                statusDiv.textContent = "Error: " + err.message;
                statusDiv.className = "status-msg error";
            })
            .EnsureToolConfigTab_Web();
    }

    function addToolConfig() {
        const statusDiv = document.getElementById('tool-config-status');
        const payload = {
            tool: document.getElementById('tool-name').value,
            cost: document.getElementById('tool-cost').value,
            capacity: document.getElementById('tool-capacity').value,
            unit: document.getElementById('tool-unit').value,
            notes: document.getElementById('tool-notes').value
        };
        statusDiv.textContent = "Adding...";
        statusDiv.className = "status-msg";
        google.script.run
            .withSuccessHandler(function (msg) {
                statusDiv.textContent = msg;
                statusDiv.className = "status-msg success";
            })
            .withFailureHandler(function (err) {
                statusDiv.textContent = "Error: " + err.message;
                statusDiv.className = "status-msg error";
            })
            .appendToolConfig_Web(payload);
    }

    // --- CASHFLOW DASHBOARD LOGIC ---

    let chartInstance = null;
    let baseData = null; // Stores the data from server
    let scenarios = []; // Stores user added scenarios
    let selectedMonthIdx = 0;
    let rangeStartIdx = 0;
    let rangeEndIdx = 0;
    let entitlementsLoaded = false;

    function loadCashflowData() {
        if (baseData) return; // Already loaded

        google.script.run
            .withSuccessHandler(function (data) {
                baseData = data;
                rangeStartIdx = 0;
                rangeEndIdx = baseData.months.length - 1;
                populateMonthSelects(data.months);
                initRangeInputs();
                renderMonthDetails(0);
                updateChart();
            })
            .withFailureHandler(function (err) {
                alert("Failed to load cashflow data: " + err.message);
            })
            .getCashflowData_Web();
    }

    // --- ENTITLEMENTS ---
    function loadEntitlements() {
        if (entitlementsLoaded) return;
        google.script.run
            .withSuccessHandler(function (data) {
                entitlementsLoaded = true;
                document.getElementById('ent-shared').textContent = formatCurrency(data.sharedCost);
                document.getElementById('ent-dedicated').textContent = formatCurrency(data.clientFundedCost);
                document.getElementById('ent-revenue').textContent = formatCurrency(data.totalToolRevenue);
                const balEl = document.getElementById('ent-balance');
                balEl.textContent = formatCurrency(data.remainingBalance);
                balEl.style.color = data.remainingBalance >= 0 ? '#27AE60' : '#EB5757';

                const tbody = document.getElementById('ent-table-body');
                if (!data.rows || !data.rows.length) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-muted">No clients found.</td></tr>';
                    return;
                }
                tbody.innerHTML = data.rows.map(r => `
                    <tr>
                        <td>${escapeHtml(r.account)}</td>
                        <td>${escapeHtml(r.market)}</td>
                        <td class="currency">${formatCurrency(r.revenue)}</td>
                        <td>${escapeHtml(r.tier)}</td>
                        <td class="currency">${formatCurrency(r.fee)}</td>
                        <td class="currency">${formatNumber(r.accu)}</td>
                        <td class="currency">${formatNumber(r.semrush)}</td>
                        <td class="currency">${formatNumber(r.oncrawl)}</td>
                        <td>${escapeHtml(r.cloud)}</td>
                    </tr>
                `).join('');
            })
            .withFailureHandler(function (err) {
                alert("Failed to load entitlements: " + err.message);
            })
            .getTechEntitlements_Web();
    }

    function initRangeInputs() {
        const startInput = document.getElementById('range-start');
        const endInput = document.getElementById('range-end');
        if (!baseData || !baseData.monthKeys) return;
        const minVal = baseData.monthKeys[0];
        const maxVal = baseData.monthKeys[baseData.monthKeys.length - 1];
        startInput.min = minVal;
        startInput.max = maxVal;
        endInput.min = minVal;
        endInput.max = maxVal;
        startInput.value = minVal;
        endInput.value = maxVal;
        startInput.addEventListener('change', handleRangeChange);
        endInput.addEventListener('change', handleRangeChange);
    }

    function handleRangeChange() {
        if (!baseData || !baseData.monthKeys) return;
        const startInput = document.getElementById('range-start');
        const endInput = document.getElementById('range-end');
        const startVal = startInput.value;
        const endVal = endInput.value;
        const startIdx = baseData.monthKeys.indexOf(startVal);
        const endIdx = baseData.monthKeys.indexOf(endVal);
        if (startIdx === -1 || endIdx === -1 || startIdx > endIdx) {
            // reset to full range if invalid
            rangeStartIdx = 0;
            rangeEndIdx = baseData.months.length - 1;
            startInput.value = baseData.monthKeys[0];
            endInput.value = baseData.monthKeys[baseData.monthKeys.length - 1];
        } else {
            rangeStartIdx = startIdx;
            rangeEndIdx = endIdx;
        }
        renderMonthDetails(rangeStartIdx);
        updateChart();
    }

    function populateMonthSelects(months) {
        const selects = [document.getElementById('scenario-tool-start'), document.getElementById('scenario-client-start')];
        selects.forEach(sel => {
            sel.innerHTML = '';
            months.forEach((m, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = m;
                sel.appendChild(opt);
            });
        });
    }

    function addToolScenario() {
        const name = document.getElementById('scenario-tool-name').value;
        const cost = parseFloat(document.getElementById('scenario-tool-cost').value);
        const startIdx = parseInt(document.getElementById('scenario-tool-start').value);

        if (!name || isNaN(cost)) {
            alert("Please enter valid tool details.");
            return;
        }

        scenarios.push({ type: 'cost', name, value: cost, startIdx });
        renderScenarioList();
        updateChart();

        // Clear inputs
        document.getElementById('scenario-tool-name').value = '';
        document.getElementById('scenario-tool-cost').value = '';
    }

    function addClientScenario() {
        const name = document.getElementById('scenario-client-name').value;
        const revenue = parseFloat(document.getElementById('scenario-client-revenue').value);
        const startIdx = parseInt(document.getElementById('scenario-client-start').value);

        if (!name || isNaN(revenue)) {
            alert("Please enter valid client details.");
            return;
        }

        scenarios.push({ type: 'revenue', name, value: revenue, startIdx });
        renderScenarioList();
        updateChart();

        // Clear inputs
        document.getElementById('scenario-client-name').value = '';
        document.getElementById('scenario-client-revenue').value = '';
    }

    function resetScenarios() {
        scenarios = [];
        renderScenarioList();
        updateChart();
    }

    function renderScenarioList() {
        const container = document.getElementById('scenario-list');
        if (scenarios.length === 0) {
            container.innerHTML = '<p class="text-muted">No scenarios active.</p>';
            return;
        }

        let html = '';
        scenarios.forEach((s, idx) => {
            const sign = s.type === 'cost' ? '-' : '+';
            const colorClass = s.type;
            html += `
                    <div class="scenario-item ${colorClass}">
                        <span><strong>${s.name}</strong> (Starts ${baseData.months[s.startIdx]})</span>
                        <span>${sign}$${s.value}/mo</span>
                    </div>
                `;
        });
        container.innerHTML = html;
    }

    function updateChart() {
        if (!baseData) return;

        const ctx = document.getElementById('cashflowChart').getContext('2d');

        // 1. Calculate Scenario Impact
        const months = baseData.months;
        const totalRevenue = [...baseData.revenue];
        const totalCosts = [...baseData.costs];

        // Apply scenarios to full timeline
        scenarios.forEach(s => {
            for (let i = s.startIdx; i < months.length; i++) {
                if (s.type === 'revenue') totalRevenue[i] += s.value;
                if (s.type === 'cost') totalCosts[i] += s.value;
            }
        });

        // Guard range indexes
        const startIdx = Math.max(0, Math.min(rangeStartIdx, months.length - 1));
        const endIdx = Math.max(startIdx, Math.min(rangeEndIdx, months.length - 1));

        // Calculate Cumulative Cash with historical offset
        let runningTotal = 0;
        for (let i = 0; i < startIdx; i++) {
            runningTotal += (totalRevenue[i] - totalCosts[i]);
        }
        const cumulativeCash = [];
        const rangeRevenue = [];
        const rangeCosts = [];
        const rangeLabels = [];
        for (let i = startIdx; i <= endIdx; i++) {
            rangeRevenue.push(totalRevenue[i]);
            rangeCosts.push(totalCosts[i]);
            rangeLabels.push(months[i]);
            runningTotal += (totalRevenue[i] - totalCosts[i]);
            cumulativeCash.push(runningTotal);
        }
        // Totals in range
        const rangeRevenueTotal = rangeRevenue.reduce((sum, v) => sum + (Number(v) || 0), 0);
        const rangeCostTotal = rangeCosts.reduce((sum, v) => sum + (Number(v) || 0), 0);
        document.getElementById('range-revenue-total').textContent = formatCurrency(rangeRevenueTotal);
        document.getElementById('range-cost-total').textContent = formatCurrency(rangeCostTotal);

        // 3. Render Chart
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: rangeLabels,
                datasets: [
                    {
                        label: 'Cumulative Cash (Line)',
                        data: cumulativeCash,
                        type: 'line',
                        borderColor: '#FFB71B', // Jellyfish Gold
                        backgroundColor: '#FFB71B',
                        borderWidth: 3,
                        yAxisID: 'y1',
                        order: 0
                    },
                    {
                        label: 'Monthly Revenue',
                        data: rangeRevenue,
                        backgroundColor: '#00cc66',
                        order: 1
                    },
                    {
                        label: 'Monthly Cost',
                        data: rangeCosts,
                        backgroundColor: '#ff4d4d',
                        order: 2
                    },
                    {
                        label: 'Zero (Cumulative)',
                        data: new Array(rangeLabels.length).fill(0),
                        type: 'line',
                        borderColor: '#d85eff',
                        borderDash: [6, 6],
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0,
                        yAxisID: 'y1',
                        order: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                onClick: (evt, activeEls) => {
                    if (!activeEls || !activeEls.length) return;
                    const firstPoint = activeEls[0];
                    if (firstPoint.index != null) {
                        renderMonthDetails(startIdx + firstPoint.index);
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Cashflow Forecast (Hybrid View)',
                        color: '#ffffff',
                        font: { size: 16, family: 'Big Shoulders Display' }
                    },
                    legend: {
                        labels: { color: '#cccccc' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#cccccc' },
                        grid: { color: '#333333' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: { color: '#cccccc' },
                        grid: { color: '#333333' },
                        title: { display: true, text: 'Monthly Amount ($)', color: '#cccccc' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#FFB71B' },
                        title: { display: true, text: 'Cumulative Cash ($)', color: '#FFB71B' }
                    }
                }
            }
        });
    }

    function renderMonthDetails(idx) {
        if (!baseData) return;
        selectedMonthIdx = idx;
        const monthLabel = baseData.months[idx] || 'Month';
        document.getElementById('month-detail-title').textContent = `Month Detail â€“ ${monthLabel}`;

        // Transactions
        const txBody = document.getElementById('tx-table-body');
        const txTotalEl = document.getElementById('tx-total');
        const tx = (baseData.monthTransactions && baseData.monthTransactions[idx]) || [];
        if (!tx.length) {
            txBody.innerHTML = '<tr><td colspan="5" class="text-muted">No transactions for this month.</td></tr>';
            txTotalEl.textContent = '(Total: $0.00)';
        } else {
            const txSorted = [...tx].sort((a, b) => (b.amount || 0) - (a.amount || 0));
            const totalTx = txSorted.reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
            txTotalEl.textContent = `(Total: ${formatCurrency(totalTx)})`;
            txBody.innerHTML = txSorted.map(t => `
                <tr>
                    <td>${escapeHtml(t.vendor || '')}</td>
                    <td>${escapeHtml(t.category || '')}</td>
                    <td class="currency">${formatCurrency(t.amount)}</td>
                    <td>${escapeHtml(t.date || '')}</td>
                    <td>${escapeHtml(t.notes || '')}</td>
                </tr>
            `).join('');
        }

        // Client revenue
        const clientBody = document.getElementById('client-table-body');
        const clientSeoTotalEl = document.getElementById('client-seo-total');
        const clientToolTotalEl = document.getElementById('client-tool-total');
        const clientsRaw = (baseData.clientRevenue && baseData.clientRevenue[idx]) || [];
        if (!clientsRaw.length) {
            clientBody.innerHTML = '<tr><td colspan="4" class="text-muted">No client revenue for this month.</td></tr>';
            clientSeoTotalEl.textContent = '(SEO: $0.00)';
            clientToolTotalEl.textContent = '(Tool: $0.00)';
        } else {
            // aggregate by account name (case-insensitive)
            const byAccount = new Map();
            clientsRaw.forEach(c => {
                const key = (c.client || '').toLowerCase();
                if (!key) return;
                const existing = byAccount.get(key) || { client: c.client, market: c.market, tool: 0, seo: 0 };
                existing.tool += Number(c.toolRevenue || 0);
                // SEO is monthly replicated; keep first non-zero if multiple
                if (!existing.seo && c.seoRevenue) existing.seo = c.seoRevenue || 0;
                // prefer first non-empty market
                if (!existing.market && c.market) existing.market = c.market;
                byAccount.set(key, existing);
            });
            const rows = Array.from(byAccount.values());
            rows.sort((a, b) => (b.tool || 0) - (a.tool || 0));
            const seoTotal = rows.reduce((sum, r) => sum + (Number(r.seo) || 0), 0);
            const toolTotal = rows.reduce((sum, r) => sum + (Number(r.tool) || 0), 0);
            clientSeoTotalEl.textContent = `(SEO: ${formatCurrency(seoTotal)})`;
            clientToolTotalEl.textContent = `(Tool: ${formatCurrency(toolTotal)})`;
            clientBody.innerHTML = rows.map(c => `
                <tr>
                    <td>${escapeHtml(c.client || '')}</td>
                    <td>${escapeHtml(c.market || '')}</td>
                    <td class="currency">${formatCurrency(c.tool || 0)}</td>
                    <td class="currency">${formatCurrency(c.seo || 0)}</td>
                </tr>
            `).join('');
        }
    }

    function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, function (m) {
            return ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[m];
        });
    }

    function formatCurrency(n) {
        const num = Number(n) || 0;
        return '$' + num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatNumber(n) {
        const num = Number(n) || 0;
        return num.toLocaleString();
    }
</script>
